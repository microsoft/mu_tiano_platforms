## @file
# Azure Pipeline to create PR to update subtree on completed commit
#
# Copyright (c) Microsoft Corporation
# SPDX-License-Identifier: BSD-2-Clause-Patent

trigger:
  branches:
    include:
    - master
  
parameters:
- name: BranchName
  type: string
  default: 'autogenerated/$(Build.RequestedForEmail)/$(Build.BuildNumber)'
- name: repositories
  type: object
  default:
    - https://github.com/Javagedes/mu_basecore
    - https://github.com/Javagedes/mu_tiano_platforms

steps:
- checkout: self
  persistCredentials: true

- $ {{each repository in parameters.repositories}}
  - script: |
      git config --global user.email "$(Build.RequestedForEmail)"
      git config --global user.name "$(Build.RequestedFor)"
  - script: git clone repository
  - script: git checkout -b $(Build.BuildNumber)
  - script: git subtree pull --prefix ./github/ https://github.com/Javagedes/mu_common_github master --squash
  - script: git -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" push origin users/$(Build.RequestedFor)/github_subtree_update
  - task: CreatePullRequest@1
    displayName: 'Create Pull Request'
    inputs:
      repoType: 'GitHub'
      repositorySelector: 